// @ts-nocheck
const qs=(t,e=document)=>e.querySelector(t),qsa=(t,e=document)=>Array.from(e.querySelectorAll(t)),pick=t=>t[Math.floor(Math.random()*t.length)],USAGE_KEY_PREFIX="dcc_usage_",isPro=()=>"1"===localStorage.getItem("dcc_pro")||!!localStorage.getItem("dcc_pro_email"),todayKey=()=>{const t=new Date;return`dcc_usage_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},getUsage=()=>parseInt(localStorage.getItem(todayKey())||"0",10),incUsage=()=>localStorage.setItem(todayKey(),String(getUsage()+1));function updateUsageCounter(){const t=qs("#usageCounter");t&&(t.textContent=isPro()?"Pro: unlimited captions":`Free today: ${Math.max(0,3-getUsage())} of 3 left`)}const FORMAT_MAP={facebook:["Post","Story","Reel"],instagram:["Post","Story","Reel"],twitter:["Post"],linkedin:["Profile","Page"],gmb:["Post"],tiktok:["Video"],ytshorts:["Short"],youtube:["Video"]},FORMAT_HINT={"facebook:post":"1–3 short paragraphs • 4–7 hashtags","facebook:story":"2–3 lines • no hashtags • link sticker","facebook:reel":"Hook + 1–2 lines • 3–5 hashtags","instagram:post":"Hook + 2–3 lines • 5–9 hashtags","instagram:story":"Very short • no hashtag soup • link sticker","instagram:reel":"Hook + benefit + CTA • 3–7 hashtags","twitter:post":"≤ 280 chars • ≤ 2 hashtags","linkedin:profile":"3–6 lines • business tone • ≤ 3 hashtags","linkedin:page":"Brand voice • ≤ 3 hashtags","gmb:post":"Plain, local keywords • no hashtags","tiktok:video":"Hook + 2 lines + CTA • 6–10 hashtags","ytshorts:short":"2–3 lines • 3–5 hashtags","youtube:video":"Title + description • avoid hashtag soup"};function refreshFormats(){const t=qs("#platform"),e=qs("#format");if(!t||!e)return;const o=String(t.value||"Facebook").toLowerCase(),a=FORMAT_MAP[o]||["Post"];e.innerHTML="";for(const t of a){const o=document.createElement("option");o.textContent=t,e.appendChild(o)}updateFormatHint()}function updateFormatHint(){const t=qs("#platform"),e=qs("#format"),o=qs("#formatHint");if(!t||!e||!o)return;const a=`${String(t.value||"Facebook").toLowerCase()}:${String(e.value||"Post").toLowerCase()}`;o.textContent=FORMAT_HINT[a]||""}function cleanPunctuation(t=""){return t.replace(/\s{2,}/g," ").replace(/([.!?])\1{1,}/g,"$1").replace(/([.!?])\s*([.!?])/g,"$1 ").replace(/\s+([,.;:!?])/g,"$1").replace(/([,.;:!?])([^\s])/g,"$1 $2").trim()}function humanize(t,{platform:e}={}){if(!t)return t;let o=cleanPunctuation(t);if("linkedin"===String(e).toLowerCase()){const t=o.split("\n");t.length>6&&(o=t.slice(0,6).join("\n"))}return o.trim()}function cleanTag(t){return t.toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"").replace(/^#+/,"")}function buildHashtags(t="",e="standard",o=!0,a="instagram",n="post"){const r=String(a||"").toLowerCase(),s=String(n||"").toLowerCase();if("gmb"===r||"youtube"===r||"story"===s)return"";let i=String(t||"").split(",").map((t=>t.trim())).filter(Boolean);o&&(i=i.map(cleanTag)),i=[...new Set(i)].filter(Boolean);let l=7;return"twitter"===r?l="heavy"===e?3:2:"linkedin"===r?l="heavy"===e?5:"light"===e?2:3:"tiktok"===r?l="heavy"===e?15:"light"===e?6:10:"ytshorts"===r&&(l="heavy"===e?7:"light"===e?3:5),i.slice(0,l).map((t=>`#${t}`)).join(" ")}function platformStyle(t){switch(String(t||"").toLowerCase()){case"linkedin":case"twitter":return{emoji:!1,lineBreaks:!0};case"tiktok":return{emoji:!0,lineBreaks:!1};default:return{emoji:!0,lineBreaks:!0}}}function makeCaption({company:t,offer:e,audience:o,problem:a,outcome:n,cta:r,platform:s,format:i,length:l,tone:c,keywords:d}){const u=platformStyle(s),m={pro:["Quick win you’ll actually use","A small change, big payoff","This fixes the ‘no time’ problem"],friendly:["Weekend vibes + real help","Hey, local friends — this helps","What if ‘marketing’ felt easy?"]},g=pick(c<=.4?m.pro:m.friendly),p=o?`For ${o},`:"For busy folks,",h=[t?`At ${t}, we get it.`:null,e||"Your offer here.",a?`You’re battling ${a} —`:null,n?`we’ll help you get ${n}.`:null].filter(Boolean).join(" "),f=r&&r.trim()?r.trim():pick(["Book now","Message us to claim","Learn more","Call today","Get a free quote"]),y=String(l||"Medium").toLowerCase(),k="short"===y?`${g}. ${e||""} ${f}`.trim():"long"===y?`${g}. ${p} ${h} ${f}.`:`${g}. ${h} ${f}.`,b=buildHashtags(d,(qs("#hashtagDensity")?.value||"Standard").toLowerCase(),!!qs("#cleanHashtags")?.checked,s,i);return humanize(u.lineBreaks?[k,b].filter(Boolean).join("\n\n"):`${k} ${b}`.trim(),{platform:s})}function renderCards(t){const e=qs("#results");e&&(e.innerHTML="",t.forEach(((t,o)=>{const a=document.createElement("article");a.className="card";const n=t.split("\n").filter((t=>t.trim().startsWith("#"))).join(" "),r=n?`\n      <div class="first-comment">\n        <div class="row" style="justify-content:space-between"><strong>First comment (copy)</strong>\n          <button type="button" class="btn secondary" data-firstcopy>Copy first comment</button>\n        </div>\n        <textarea readonly>${n}</textarea>\n      </div>`:"";a.innerHTML=`\n      <h3>Caption ${o+1}</h3>\n      <textarea id="cap_${o+1}" readonly>${t}</textarea>\n      <div class="row">\n        <button type="button" class="btn" data-copy="cap_${o+1}">Copy</button>\n        <span class="meta muted">Auto-formatted</span>\n      </div>\n      ${r}\n    `,e.appendChild(a)})),e.addEventListener("click",(t=>{const e=t.target.closest("button[data-copy]");if(e){const t=e.getAttribute("data-copy"),o=document.getElementById(t);o&&(o.select(),document.execCommand("copy"),e.textContent="Copied!",setTimeout((()=>e.textContent="Copy"),1e3))}if(t.target.matches("button[data-firstcopy]")){const e=t.target.closest(".first-comment")?.querySelector("textarea");e&&(e.select(),document.execCommand("copy"),t.target.textContent="Copied!",setTimeout((()=>t.target.textContent="Copy first comment"),1e3))}}),{once:!0}))}const WORKER_URLS=["https://www.bluedobiedev.com/api/remix","https://dobiecore-remix.melanie-brown.workers.dev"];async function maybeRemixWithAI(t,e){if(!isPro())return t;const o={drafts:t.map(((t,e)=>({id:String(e+1),text:t}))),platform:e.platform,tone:e.tone,length:e.length,ctaOptions:[e.cta].filter(Boolean),hashtags:buildHashtags(e.keywords,(e.hashtagDensity||"standard").toLowerCase(),!1!==e.cleanHashtags,e.platform,e.format)};for(const t of WORKER_URLS)try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)continue;const a=await e.json();if(Array.isArray(a)&&a.length)return a.map((t=>String(t.text||""))).filter(Boolean)}catch{}return console.warn("AI remix unavailable; using local drafts"),t}function readBrief(){const t=t=>qs(`#${t}`)?.value?.trim()||"";return{company:t("company"),offer:t("offer"),audience:t("audience"),problem:t("problem"),outcome:t("outcome"),cta:t("cta"),keywords:t("keywords"),platform:t("platform")||"Instagram",format:t("format")||"Post",length:t("captionLength")||"Medium",tone:parseFloat(t("tone")||"0.5"),hashtagDensity:t("hashtagDensity")||"Standard",cleanHashtags:!1!==qs("#cleanHashtags")?.checked}}!function(){const t=qs("#captionForm"),e=qs("#results");if(!t||!e)return void console.warn("DobieCore Captions: required DOM not found.");refreshFormats(),updateUsageCounter();const o=qs("#tone"),a=o?.nextElementSibling;o?.addEventListener("input",(()=>{const t=parseFloat(o.value||"0.5");a&&(a.textContent=t<.35?"Professional":t>.65?"Playful":"Balanced")})),qs("#platform")?.addEventListener("change",refreshFormats),qs("#format")?.addEventListener("change",updateFormatHint);const n=qs("#upgradeModal");qs("#upgradeBtn")?.addEventListener("click",(()=>window.location.href="https://buy.stripe.com/6oUaEY6oTaHBcd6drP0x203")),qs("#alreadyProBtn")?.addEventListener("click",(()=>{const t=prompt("Enter the email you used to upgrade (temporary local unlock):");t&&/\S+@\S+\.\S+/.test(t)?(localStorage.setItem("dcc_pro_email",t),localStorage.setItem("dcc_pro","1"),updateUsageCounter(),n?.setAttribute("hidden",""),alert("Pro unlocked on this browser.")):alert("That email doesn’t look valid.")})),qs("#closeModalBtn")?.addEventListener("click",(()=>n?.setAttribute("hidden",""))),window.addEventListener("click",(t=>{t.target===n&&n?.setAttribute("hidden","")})),t.addEventListener("submit",(async t=>{t.preventDefault();const o=readBrief();if(!o.offer)return alert("Please add what you’re promoting (the Offer)."),void qs("#offer")?.focus();if(!isPro()&&getUsage()>=3)return void n?.removeAttribute("hidden");const a=[makeCaption(o),makeCaption(o),makeCaption(o)];renderCards(await maybeRemixWithAI(a,o)),isPro()||(incUsage(),updateUsageCounter()),e.scrollIntoView({behavior:"smooth",block:"start"})})),qs("#clearBtn")?.addEventListener("click",(()=>{["company","offer","audience","problem","outcome","cta","keywords"].forEach((t=>{const e=qs(`#${t}`);e&&(e.value="")})),qs("#captionLength")&&(qs("#captionLength").value="Medium"),qs("#hashtagDensity")&&(qs("#hashtagDensity").value="Standard"),qs("#cleanHashtags")&&(qs("#cleanHashtags").checked=!0),qs("#tone")&&(qs("#tone").value=.5),e.innerHTML=""}))}();