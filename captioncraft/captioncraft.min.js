// @ts-nocheck
const qs=(e,t=document)=>t.querySelector(e),qsa=(e,t=document)=>Array.from(t.querySelectorAll(e)),pick=e=>e[Math.floor(Math.random()*e.length)],USAGE_KEY_PREFIX="dcc_usage_",API_BASE="https://dobiecore-remix.melanie-brown.workers.dev/api";async function isPro(){const e=localStorage.getItem("dcc_email");if(!e)return!1;const t="dcc_pro_cache",o="dcc_pro_cache_time",a=localStorage.getItem(t),n=parseInt(localStorage.getItem(o)||"0"),r=Date.now();if("true"===a&&r-n<3e5)return!0;try{const a=await fetch(`${API_BASE}/check-pro`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(a.ok){if((await a.json()).isPro)return localStorage.setItem(t,"true"),localStorage.setItem(o,String(r)),!0}}catch(e){console.warn("Pro check failed, using local cache:",e)}return localStorage.removeItem(t),localStorage.removeItem(o),!1}const todayKey=()=>{const e=new Date;return`dcc_usage_${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},getUsage=()=>parseInt(localStorage.getItem(todayKey())||"0",10),incUsage=()=>localStorage.setItem(todayKey(),String(getUsage()+1));async function updateUsageCounter(){const e=qs("#usageCounter");if(!e)return;const t=await isPro();e.textContent=t?"Pro: unlimited captions":`Free today: ${Math.max(0,3-getUsage())} of 3 left`}const FORMAT_MAP={facebook:["Post","Story","Reel"],instagram:["Post","Story","Reel"],twitter:["Post"],linkedin:["Profile","Page"],gmb:["Post"],tiktok:["Video"],ytshorts:["Short"],youtube:["Video"]},FORMAT_HINT={"facebook:post":"1–3 short paragraphs • 4–7 hashtags","facebook:story":"2–3 lines • no hashtags • link sticker","facebook:reel":"Hook + 1–2 lines • 3–5 hashtags","instagram:post":"Hook + 2–3 lines • 5–9 hashtags","instagram:story":"Very short • no hashtag soup • link sticker","instagram:reel":"Hook + benefit + CTA • 3–7 hashtags","twitter:post":"≤ 280 chars • ≤ 2 hashtags","linkedin:profile":"3–6 lines • business tone • ≤ 3 hashtags","linkedin:page":"Brand voice • ≤ 3 hashtags","gmb:post":"Plain, local keywords • no hashtags","tiktok:video":"Hook + 2 lines + CTA • 6–10 hashtags","ytshorts:short":"2–3 lines • 3–5 hashtags","youtube:video":"Title + description • avoid hashtag soup"};function refreshFormats(){const e=qs("#platform"),t=qs("#format");if(!e||!t)return;const o=String(e.value||"Facebook").toLowerCase(),a=FORMAT_MAP[o]||["Post"];t.innerHTML="";for(const e of a){const o=document.createElement("option");o.textContent=e,t.appendChild(o)}updateFormatHint()}function updateFormatHint(){const e=qs("#platform"),t=qs("#format"),o=qs("#formatHint");if(!e||!t||!o)return;const a=`${String(e.value||"Facebook").toLowerCase()}:${String(t.value||"Post").toLowerCase()}`;o.textContent=FORMAT_HINT[a]||""}function cleanPunctuation(e=""){return e.replace(/\s{2,}/g," ").replace(/([.!?])\1{1,}/g,"$1").replace(/([.!?])\s*([.!?])/g,"$1 ").replace(/\s+([,.;:!?])/g,"$1").replace(/([,.;:!?])([^\s])/g,"$1 $2").trim()}function humanize(e,{platform:t}={}){if(!e)return e;let o=cleanPunctuation(e);if("linkedin"===String(t).toLowerCase()){const e=o.split("\n");e.length>6&&(o=e.slice(0,6).join("\n"))}return o.trim()}function cleanTag(e){return e.toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"").replace(/^#+/,"")}function extractKeywordsFromOffer(e,t){if(!e||"string"!=typeof e)return"";const o=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","up","about","into","through","during","including","until","against","among","throughout","despite","towards","upon","concerning","that","this","these","those","is","are","was","were","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","your","our","their","its","get","now","just","more","new","come","get"]),a=e.toLowerCase().replace(/[^\w\s-]/g," ").split(/\s+/).filter((e=>e.length>3&&!o.has(e)&&!/^\d+$/.test(e))),n=[...new Set(a)].slice(0,5),r={instagram:"instagram",linkedin:"linkedin",facebook:"facebook",twitter:"twitter",tiktok:"tiktok"}[t?.toLowerCase()];return r&&n.length<5&&!n.includes(r)&&n.push(r),n.join(", ")}function buildHashtags(e="",t="standard",o=!0,a="instagram",n="post"){const r=String(a||"").toLowerCase(),s=String(n||"").toLowerCase();if("gmb"===r||"youtube"===r||"story"===s)return"";let i=String(e||"").split(",").map((e=>e.trim())).filter(Boolean);o&&(i=i.map(cleanTag)),i=[...new Set(i)].filter(Boolean);let c=7;return"twitter"===r?c="heavy"===t?3:2:"linkedin"===r?c="heavy"===t?5:"light"===t?2:3:"tiktok"===r?c="heavy"===t?15:"light"===t?6:10:"ytshorts"===r&&(c="heavy"===t?7:"light"===t?3:5),i.slice(0,c).map((e=>`#${e}`)).join(" ")}function platformStyle(e){switch(String(e||"").toLowerCase()){case"linkedin":case"twitter":return{emoji:!1,lineBreaks:!0};case"tiktok":return{emoji:!0,lineBreaks:!1};default:return{emoji:!0,lineBreaks:!0}}}function makeCaption({company:e,offer:t,audience:o,problem:a,outcome:n,cta:r,platform:s,format:i,length:c,tone:l,keywords:d}){const u=platformStyle(s),m={pro:["Quick win you'll actually use","A small change, big payoff","This fixes the 'no time' problem"],friendly:["Weekend vibes + real help","Hey, local friends — this helps","What if 'marketing' felt easy?"]},g=pick(l<=.4?m.pro:m.friendly),h=o?`For ${o},`:"For busy folks,",f=[e?`At ${e}, we get it.`:null,t||"Your offer here.",a?`You're battling ${a} —`:null,n?`we'll help you get ${n}.`:null].filter(Boolean).join(" "),p=r&&r.trim()?r.trim():pick(["Book now","Message us to claim","Learn more","Call today","Get a free quote"]),y=String(c||"Medium").toLowerCase(),w="short"===y?`${g}. ${t||""} ${p}`.trim():"long"===y?`${g}. ${h} ${f} ${p}.`:`${g}. ${f} ${p}.`,k=buildHashtags(d,(qs("#hashtagDensity")?.value||"Standard").toLowerCase(),!!qs("#cleanHashtags")?.checked,s,i);return humanize(u.lineBreaks?[w,k].filter(Boolean).join("\n\n"):`${w} ${k}`.trim(),{platform:s})}function renderCards(e){const t=qs("#results");t&&(t.innerHTML="",e.forEach(((e,o)=>{const a=document.createElement("article");a.className="card";const n=e.split("\n").filter((e=>e.trim().startsWith("#"))).join(" "),r=n?`\n      <div class="first-comment">\n        <div class="row" style="justify-content:space-between"><strong>First comment (copy)</strong>\n          <button type="button" class="btn secondary" data-firstcopy>Copy first comment</button>\n        </div>\n        <textarea readonly>${n}</textarea>\n      </div>`:"";a.innerHTML=`\n      <h3>Caption ${o+1}</h3>\n      <textarea id="cap_${o+1}" readonly>${e}</textarea>\n      <div class="row">\n        <button type="button" class="btn" data-copy="cap_${o+1}">Copy</button>\n        <span class="meta muted">Auto-formatted</span>\n      </div>\n      ${r}\n    `,t.appendChild(a)})),t.addEventListener("click",(e=>{const t=e.target.closest("button[data-copy]");if(t){const e=t.getAttribute("data-copy"),o=document.getElementById(e);o&&(o.select(),document.execCommand("copy"),t.textContent="Copied!",setTimeout((()=>t.textContent="Copy"),1e3))}if(e.target.matches("button[data-firstcopy]")){const t=e.target.closest(".first-comment")?.querySelector("textarea");t&&(t.select(),document.execCommand("copy"),e.target.textContent="Copied!",setTimeout((()=>e.target.textContent="Copy first comment"),1e3))}}),{once:!0}))}const WORKER_URLS=[`${API_BASE}/remix`,"https://www.bluedobiedev.com/api/remix"];async function maybeRemixWithAI(e,t){const{traits:o,custom:a,remember:n}=getBrandVoiceSelections(),r={email:t.email,company:t.company,offer:t.offer,audience:t.audience,problem:t.problem,outcome:t.outcome};for(const e of WORKER_URLS)try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!t.ok)continue;const o=await t.json();if(Array.isArray(o)&&o.length)return o.map((e=>String(e.text||""))).filter(Boolean)}catch{}return console.warn("AI remix unavailable; using local drafts"),e}function readBrief(){const e=e=>qs(`#${e}`)?.value?.trim()||"";return{email:e("email"),company:e("company"),offer:e("offer"),audience:e("audience"),problem:e("problem"),outcome:e("outcome"),cta:e("cta"),keywords:e("keywords"),platform:e("platform")||"Instagram",format:e("format")||"Post",length:e("captionLength")||"Medium",tone:parseFloat(e("tone")||"0.5"),hashtagDensity:e("hashtagDensity")||"Standard",cleanHashtags:!1!==qs("#cleanHashtags")?.checked}}!function(){const e=qs("#captionForm"),t=qs("#results");if(!e||!t)return void console.warn("DobieCore Captions: required DOM not found.");refreshFormats(),updateUsageCounter();const o=qs("#tone"),a=o?.nextElementSibling;o?.addEventListener("input",(()=>{const e=parseFloat(o.value||"0.5");a&&(a.textContent=e<.35?"Professional":e>.65?"Playful":"Balanced")})),qs("#platform")?.addEventListener("change",refreshFormats),qs("#format")?.addEventListener("change",updateFormatHint);const n=qs("#upgradeModal");qs("#upgradeBtn")?.addEventListener("click",(()=>window.location.href="https://buy.stripe.com/6oU8wPfjX591as29Hg3Je03")),qs("#alreadyProBtn")?.addEventListener("click",(()=>{const e=prompt("Enter the email you used to purchase (this will verify with our system):");e&&/\S+@\S+\.\S+/.test(e)?(localStorage.setItem("dcc_email",e.toLowerCase()),localStorage.removeItem("dcc_pro_cache"),localStorage.removeItem("dcc_pro_cache_time"),updateUsageCounter(),n?.setAttribute("hidden",""),alert("Checking your pro status. If you just purchased, please wait a moment and try generating a caption.")):alert("That email doesn't look valid.")})),qs("#closeModalBtn")?.addEventListener("click",(()=>n?.setAttribute("hidden",""))),window.addEventListener("click",(e=>{e.target===n&&n?.setAttribute("hidden","")})),e.addEventListener("submit",(async e=>{e.preventDefault();const o=readBrief();if(!o.email||!/\S+@\S+\.\S+/.test(o.email))return alert("Please enter a valid email address."),void qs("#email")?.focus();if(!o.offer)return alert("Please add what you're promoting (the Offer)."),void qs("#offer")?.focus();const a=await isPro();if(!a&&getUsage()>=3)return void n?.removeAttribute("hidden");o.keywords&&""!==o.keywords.trim()||(o.keywords=extractKeywordsFromOffer(o.offer,o.platform));renderCards(await maybeRemixWithAI([],o)),a||(incUsage(),updateUsageCounter()),t.scrollIntoView({behavior:"smooth",block:"start"})})),qs("#clearBtn")?.addEventListener("click",(()=>{["email","company","offer","audience","problem","outcome","cta","keywords"].forEach((e=>{const t=qs(`#${e}`);t&&(t.value="")})),qs("#captionLength")&&(qs("#captionLength").value="Medium"),qs("#hashtagDensity")&&(qs("#hashtagDensity").value="Standard"),qs("#cleanHashtags")&&(qs("#cleanHashtags").checked=!0),qs("#tone")&&(qs("#tone").value=.5),t.innerHTML=""}))}();