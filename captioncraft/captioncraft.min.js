// @ts-nocheck
const qs=(t,e=document)=>e.querySelector(t),qsa=(t,e=document)=>Array.from(e.querySelectorAll(t)),pick=t=>t[Math.floor(Math.random()*t.length)],USAGE_KEY_PREFIX="dcc_usage_",API_BASE="https://dobiecore-remix.melanie-brown.workers.dev/api";async function isPro(){const t=localStorage.getItem("dcc_email");if(!t)return!1;const e="dcc_pro_cache",a="dcc_pro_cache_time",o=localStorage.getItem(e),n=parseInt(localStorage.getItem(a)||"0"),r=Date.now();if("true"===o&&r-n<3e5)return!0;try{const o=await fetch(`${API_BASE}/check-pro`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(o.ok){if((await o.json()).isPro)return localStorage.setItem(e,"true"),localStorage.setItem(a,String(r)),!0}}catch(t){console.warn("Pro check failed, using local cache:",t)}return localStorage.removeItem(e),localStorage.removeItem(a),!1}const todayKey=()=>{const t=new Date;return`dcc_usage_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},getUsage=()=>parseInt(localStorage.getItem(todayKey())||"0",10),incUsage=()=>localStorage.setItem(todayKey(),String(getUsage()+1));async function updateUsageCounter(){const t=qs("#usageCounter");if(!t)return;const e=await isPro();t.textContent=e?"Pro: unlimited captions":`Free today: ${Math.max(0,3-getUsage())} of 3 left`}const FORMAT_MAP={facebook:["Post","Story","Reel"],instagram:["Post","Story","Reel"],twitter:["Post"],linkedin:["Profile","Page"],gmb:["Post"],tiktok:["Video"],ytshorts:["Short"],youtube:["Video"]},FORMAT_HINT={"facebook:post":"1–3 short paragraphs • 4–7 hashtags","facebook:story":"2–3 lines • no hashtags • link sticker","facebook:reel":"Hook + 1–2 lines • 3–5 hashtags","instagram:post":"Hook + 2–3 lines • 5–9 hashtags","instagram:story":"Very short • no hashtag soup • link sticker","instagram:reel":"Hook + benefit + CTA • 3–7 hashtags","twitter:post":"≤ 280 chars • ≤ 2 hashtags","linkedin:profile":"3–6 lines • business tone • ≤ 3 hashtags","linkedin:page":"Brand voice • ≤ 3 hashtags","gmb:post":"Plain, local keywords • no hashtags","tiktok:video":"Hook + 2 lines + CTA • 6–10 hashtags","ytshorts:short":"2–3 lines • 3–5 hashtags","youtube:video":"Title + description • avoid hashtag soup"};function refreshFormats(){const t=qs("#platform"),e=qs("#format");if(!t||!e)return;const a=String(t.value||"Facebook").toLowerCase(),o=FORMAT_MAP[a]||["Post"];e.innerHTML="";for(const t of o){const a=document.createElement("option");a.textContent=t,e.appendChild(a)}updateFormatHint()}function updateFormatHint(){const t=qs("#platform"),e=qs("#format"),a=qs("#formatHint");if(!t||!e||!a)return;const o=`${String(t.value||"Facebook").toLowerCase()}:${String(e.value||"Post").toLowerCase()}`;a.textContent=FORMAT_HINT[o]||""}function cleanPunctuation(t=""){return t.replace(/\s{2,}/g," ").replace(/([.!?])\1{1,}/g,"$1").replace(/([.!?])\s*([.!?])/g,"$1 ").replace(/\s+([,.;:!?])/g,"$1").replace(/([,.;:!?])([^\s])/g,"$1 $2").trim()}function humanize(t,{platform:e}={}){if(!t)return t;let a=cleanPunctuation(t);if("linkedin"===String(e).toLowerCase()){const t=a.split("\n");t.length>6&&(a=t.slice(0,6).join("\n"))}return a.trim()}function cleanTag(t){return t.toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"").replace(/^#+/,"")}function buildHashtags(t="",e="standard",a=!0,o="instagram",n="post"){const r=String(o||"").toLowerCase(),s=String(n||"").toLowerCase();if("gmb"===r||"youtube"===r||"story"===s)return"";let i=String(t||"").split(",").map((t=>t.trim())).filter(Boolean);a&&(i=i.map(cleanTag)),i=[...new Set(i)].filter(Boolean);let c=7;return"twitter"===r?c="heavy"===e?3:2:"linkedin"===r?c="heavy"===e?5:"light"===e?2:3:"tiktok"===r?c="heavy"===e?15:"light"===e?6:10:"ytshorts"===r&&(c="heavy"===e?7:"light"===e?3:5),i.slice(0,c).map((t=>`#${t}`)).join(" ")}function platformStyle(t){switch(String(t||"").toLowerCase()){case"linkedin":case"twitter":return{emoji:!1,lineBreaks:!0};case"tiktok":return{emoji:!0,lineBreaks:!1};default:return{emoji:!0,lineBreaks:!0}}}function makeCaption({company:t,offer:e,audience:a,problem:o,outcome:n,cta:r,platform:s,format:i,length:c,tone:l,keywords:d}){const m=platformStyle(s),u={pro:["Quick win you'll actually use","A small change, big payoff","This fixes the 'no time' problem"],friendly:["Weekend vibes + real help","Hey, local friends — this helps","What if 'marketing' felt easy?"]},g=pick(l<=.4?u.pro:u.friendly),h=a?`For ${a},`:"For busy folks,",p=[t?`At ${t}, we get it.`:null,e||"Your offer here.",o?`You're battling ${o} —`:null,n?`we'll help you get ${n}.`:null].filter(Boolean).join(" "),f=r&&r.trim()?r.trim():pick(["Book now","Message us to claim","Learn more","Call today","Get a free quote"]),y=String(c||"Medium").toLowerCase(),k="short"===y?`${g}. ${e||""} ${f}`.trim():"long"===y?`${g}. ${h} ${p} ${f}.`:`${g}. ${p} ${f}.`,b=buildHashtags(d,(qs("#hashtagDensity")?.value||"Standard").toLowerCase(),!!qs("#cleanHashtags")?.checked,s,i);return humanize(m.lineBreaks?[k,b].filter(Boolean).join("\n\n"):`${k} ${b}`.trim(),{platform:s})}function renderCards(t){const e=qs("#results");e&&(e.innerHTML="",t.forEach(((t,a)=>{const o=document.createElement("article");o.className="card";const n=t.split("\n").filter((t=>t.trim().startsWith("#"))).join(" "),r=n?`\n      <div class="first-comment">\n        <div class="row" style="justify-content:space-between"><strong>First comment (copy)</strong>\n          <button type="button" class="btn secondary" data-firstcopy>Copy first comment</button>\n        </div>\n        <textarea readonly>${n}</textarea>\n      </div>`:"";o.innerHTML=`\n      <h3>Caption ${a+1}</h3>\n      <textarea id="cap_${a+1}" readonly>${t}</textarea>\n      <div class="row">\n        <button type="button" class="btn" data-copy="cap_${a+1}">Copy</button>\n        <span class="meta muted">Auto-formatted</span>\n      </div>\n      ${r}\n    `,e.appendChild(o)})),e.addEventListener("click",(t=>{const e=t.target.closest("button[data-copy]");if(e){const t=e.getAttribute("data-copy"),a=document.getElementById(t);a&&(a.select(),document.execCommand("copy"),e.textContent="Copied!",setTimeout((()=>e.textContent="Copy"),1e3))}if(t.target.matches("button[data-firstcopy]")){const e=t.target.closest(".first-comment")?.querySelector("textarea");e&&(e.select(),document.execCommand("copy"),t.target.textContent="Copied!",setTimeout((()=>t.target.textContent="Copy first comment"),1e3))}}),{once:!0}))}const WORKER_URLS=[`${API_BASE}/remix`,"https://www.bluedobiedev.com/api/remix"];async function maybeRemixWithAI(t,e){const{traits:a,custom:o,remember:n}=getBrandVoiceSelections(),r={email:e.email,drafts:t.map(((t,e)=>({id:String(e+1),text:t}))),platform:e.platform,tone:e.tone,length:e.length,ctaOptions:[e.cta].filter(Boolean),hashtags:buildHashtags(e.keywords,(e.hashtagDensity||"standard").toLowerCase(),!1!==e.cleanHashtags,e.platform,e.format),brandVoice:{traits:a,custom:o,remember:n}};for(const t of WORKER_URLS)try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok)continue;const a=await e.json();if(Array.isArray(a)&&a.length)return a.map((t=>String(t.text||""))).filter(Boolean)}catch{}return console.warn("AI remix unavailable; using local drafts"),t}function readBrief(){const t=t=>qs(`#${t}`)?.value?.trim()||"";return{email:t("email"),company:t("company"),offer:t("offer"),audience:t("audience"),problem:t("problem"),outcome:t("outcome"),cta:t("cta"),keywords:t("keywords"),platform:t("platform")||"Instagram",format:t("format")||"Post",length:t("captionLength")||"Medium",tone:parseFloat(t("tone")||"0.5"),hashtagDensity:t("hashtagDensity")||"Standard",cleanHashtags:!1!==qs("#cleanHashtags")?.checked}}!function(){const t=qs("#captionForm"),e=qs("#results");if(!t||!e)return void console.warn("DobieCore Captions: required DOM not found.");refreshFormats(),updateUsageCounter();const a=qs("#tone"),o=a?.nextElementSibling;a?.addEventListener("input",(()=>{const t=parseFloat(a.value||"0.5");o&&(o.textContent=t<.35?"Professional":t>.65?"Playful":"Balanced")})),qs("#platform")?.addEventListener("change",refreshFormats),qs("#format")?.addEventListener("change",updateFormatHint);const n=qs("#upgradeModal");qs("#upgradeBtn")?.addEventListener("click",(()=>window.location.href="https://buy.stripe.com/6oU8wPfjX591as29Hg3Je03")),qs("#alreadyProBtn")?.addEventListener("click",(()=>{const t=prompt("Enter the email you used to purchase (this will verify with our system):");t&&/\S+@\S+\.\S+/.test(t)?(localStorage.setItem("dcc_email",t.toLowerCase()),localStorage.removeItem("dcc_pro_cache"),localStorage.removeItem("dcc_pro_cache_time"),updateUsageCounter(),n?.setAttribute("hidden",""),alert("Checking your pro status. If you just purchased, please wait a moment and try generating a caption.")):alert("That email doesn't look valid.")})),qs("#closeModalBtn")?.addEventListener("click",(()=>n?.setAttribute("hidden",""))),window.addEventListener("click",(t=>{t.target===n&&n?.setAttribute("hidden","")})),t.addEventListener("submit",(async t=>{t.preventDefault();const a=readBrief();if(!a.email||!/\S+@\S+\.\S+/.test(a.email))return alert("Please enter a valid email address."),void qs("#email")?.focus();if(!a.offer)return alert("Please add what you're promoting (the Offer)."),void qs("#offer")?.focus();const o=await isPro();if(!o&&getUsage()>=3)return void n?.removeAttribute("hidden");const r=[makeCaption(a),makeCaption(a),makeCaption(a)];renderCards(await maybeRemixWithAI(r,a)),o||(incUsage(),updateUsageCounter()),e.scrollIntoView({behavior:"smooth",block:"start"})})),qs("#clearBtn")?.addEventListener("click",(()=>{["email","company","offer","audience","problem","outcome","cta","keywords"].forEach((t=>{const e=qs(`#${t}`);e&&(e.value="")})),qs("#captionLength")&&(qs("#captionLength").value="Medium"),qs("#hashtagDensity")&&(qs("#hashtagDensity").value="Standard"),qs("#cleanHashtags")&&(qs("#cleanHashtags").checked=!0),qs("#tone")&&(qs("#tone").value=.5),e.innerHTML=""}))}();