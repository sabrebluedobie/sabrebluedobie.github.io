// @ts-nocheck
const qs=(t,e=document)=>e.querySelector(t),qsa=(t,e=document)=>Array.from(e.querySelectorAll(t)),pick=t=>t[Math.floor(Math.random()*t.length)],USAGE_KEY_PREFIX="dcc_usage_",API_BASE="https://dobiecore-remix.melanie-brown.workers.dev/api";async function isPro(){const t=localStorage.getItem("dcc_email");if(!t)return!1;const e="dcc_pro_cache",o="dcc_pro_cache_time",a=localStorage.getItem(e),n=parseInt(localStorage.getItem(o)||"0"),r=Date.now();if("true"===a&&r-n<3e5)return!0;try{const a=await fetch(`${API_BASE}/check-pro`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})});if(a.ok){if((await a.json()).isPro)return localStorage.setItem(e,"true"),localStorage.setItem(o,String(r)),!0}}catch(t){console.warn("Pro check failed, using local cache:",t)}return localStorage.removeItem(e),localStorage.removeItem(o),!1}const todayKey=()=>{const t=new Date;return`dcc_usage_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`},getUsage=()=>parseInt(localStorage.getItem(todayKey())||"0",10),incUsage=()=>localStorage.setItem(todayKey(),String(getUsage()+1));async function updateUsageCounter(){const t=qs("#usageCounter");if(!t)return;const e=await isPro();t.textContent=e?"Pro: unlimited captions":`Free today: ${Math.max(0,3-getUsage())} of 3 left`}const FORMAT_MAP={facebook:["Post","Story","Reel"],instagram:["Post","Story","Reel"],twitter:["Post"],linkedin:["Profile","Page"],gmb:["Post"],tiktok:["Video"],ytshorts:["Short"],youtube:["Video"]},FORMAT_HINT={"facebook:post":"1–3 short paragraphs • 4–7 hashtags","facebook:story":"2–3 lines • no hashtags • link sticker","facebook:reel":"Hook + 1–2 lines • 3–5 hashtags","instagram:post":"Hook + 2–3 lines • 5–9 hashtags","instagram:story":"Very short • no hashtag soup • link sticker","instagram:reel":"Hook + benefit + CTA • 3–7 hashtags","twitter:post":"≤ 280 chars • ≤ 2 hashtags","linkedin:profile":"3–6 lines • business tone • ≤ 3 hashtags","linkedin:page":"Brand voice • ≤ 3 hashtags","gmb:post":"Plain, local keywords • no hashtags","tiktok:video":"Hook + 2 lines + CTA • 6–10 hashtags","ytshorts:short":"2–3 lines • 3–5 hashtags","youtube:video":"Title + description • avoid hashtag soup"};function refreshFormats(){const t=qs("#platform"),e=qs("#format");if(!t||!e)return;const o=String(t.value||"Facebook").toLowerCase(),a=FORMAT_MAP[o]||["Post"];e.innerHTML="";for(const t of a){const o=document.createElement("option");o.textContent=t,e.appendChild(o)}updateFormatHint()}function updateFormatHint(){const t=qs("#platform"),e=qs("#format"),o=qs("#formatHint");if(!t||!e||!o)return;const a=`${String(t.value||"Facebook").toLowerCase()}:${String(e.value||"Post").toLowerCase()}`;o.textContent=FORMAT_HINT[a]||""}function cleanPunctuation(t=""){return t.replace(/\s{2,}/g," ").replace(/([.!?])\1{1,}/g,"$1").replace(/([.!?])\s*([.!?])/g,"$1 ").replace(/\s+([,.;:!?])/g,"$1").replace(/([,.;:!?])([^\s])/g,"$1 $2").trim()}function humanize(t,{platform:e}={}){if(!t)return t;let o=cleanPunctuation(t);if("linkedin"===String(e).toLowerCase()){const t=o.split("\n");t.length>6&&(o=t.slice(0,6).join("\n"))}return o.trim()}function cleanTag(t){return t.toLowerCase().replace(/&/g,"and").replace(/[^a-z0-9]+/g,"").replace(/^#+/,"")}function extractKeywordsFromOffer(t,e){if(!t||"string"!=typeof t)return"";const o=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","up","about","into","through","during","including","until","against","among","throughout","despite","towards","upon","concerning","that","this","these","those","is","are","was","were","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","your","our","their","its","get","now","just","more","new","come","get"]),a=t.toLowerCase().replace(/[^\w\s-]/g," ").split(/\s+/).filter((t=>t.length>3&&!o.has(t)&&!/^\d+$/.test(t))),n=[...new Set(a)].slice(0,5),r={instagram:"instagram",linkedin:"linkedin",facebook:"facebook",twitter:"twitter",tiktok:"tiktok"}[e?.toLowerCase()];return r&&n.length<5&&!n.includes(r)&&n.push(r),n.join(", ")}function buildHashtags(t="",e="standard",o=!0,a="instagram",n="post"){const r=String(a||"").toLowerCase(),s=String(n||"").toLowerCase();if("gmb"===r||"youtube"===r||"story"===s)return"";let i=String(t||"").split(",").map((t=>t.trim())).filter(Boolean);o&&(i=i.map(cleanTag)),i=[...new Set(i)].filter(Boolean);let c=7;return"twitter"===r?c="heavy"===e?3:2:"linkedin"===r?c="heavy"===e?5:"light"===e?2:3:"tiktok"===r?c="heavy"===e?15:"light"===e?6:10:"ytshorts"===r&&(c="heavy"===e?7:"light"===e?3:5),i.slice(0,c).map((t=>`#${t}`)).join(" ")}function platformStyle(t){switch(String(t||"").toLowerCase()){case"linkedin":case"twitter":return{emoji:!1,lineBreaks:!0};case"tiktok":return{emoji:!0,lineBreaks:!1};default:return{emoji:!0,lineBreaks:!0}}}function makeCaption({company:t,offer:e,audience:o,problem:a,outcome:n,cta:r,platform:s,format:i,length:c,tone:l,keywords:d}){const u=platformStyle(s),m={pro:["Quick win you'll actually use","A small change, big payoff","This fixes the 'no time' problem"],friendly:["Weekend vibes + real help","Hey, local friends — this helps","What if 'marketing' felt easy?"]},g=pick(l<=.4?m.pro:m.friendly),h=o?`For ${o},`:"For busy folks,",f=[t?`At ${t}, we get it.`:null,e||"Your offer here.",a?`You're battling ${a} —`:null,n?`we'll help you get ${n}.`:null].filter(Boolean).join(" "),p=r&&r.trim()?r.trim():pick(["Book now","Message us to claim","Learn more","Call today","Get a free quote"]),y=String(c||"Medium").toLowerCase(),k="short"===y?`${g}. ${e||""} ${p}`.trim():"long"===y?`${g}. ${h} ${f} ${p}.`:`${g}. ${f} ${p}.`,w=buildHashtags(d,(qs("#hashtagDensity")?.value||"Standard").toLowerCase(),!!qs("#cleanHashtags")?.checked,s,i);return humanize(u.lineBreaks?[k,w].filter(Boolean).join("\n\n"):`${k} ${w}`.trim(),{platform:s})}function renderCards(t){const e=qs("#results");e&&(e.innerHTML="",t.forEach(((t,o)=>{const a=document.createElement("article");a.className="card";const n=t.split("\n").filter((t=>t.trim().startsWith("#"))).join(" "),r=n?`\n      <div class="first-comment">\n        <div class="row" style="justify-content:space-between"><strong>First comment (copy)</strong>\n          <button type="button" class="btn secondary" data-firstcopy>Copy first comment</button>\n        </div>\n        <textarea readonly>${n}</textarea>\n      </div>`:"";a.innerHTML=`\n      <h3>Caption ${o+1}</h3>\n      <textarea id="cap_${o+1}" readonly>${t}</textarea>\n      <div class="row">\n        <button type="button" class="btn" data-copy="cap_${o+1}">Copy</button>\n        <span class="meta muted">Auto-formatted</span>\n      </div>\n      ${r}\n    `,e.appendChild(a)})),e.addEventListener("click",(t=>{const e=t.target.closest("button[data-copy]");if(e){const t=e.getAttribute("data-copy"),o=document.getElementById(t);o&&(o.select(),document.execCommand("copy"),e.textContent="Copied!",setTimeout((()=>e.textContent="Copy"),1e3))}if(t.target.matches("button[data-firstcopy]")){const e=t.target.closest(".first-comment")?.querySelector("textarea");e&&(e.select(),document.execCommand("copy"),t.target.textContent="Copied!",setTimeout((()=>t.target.textContent="Copy first comment"),1e3))}}),{once:!0}))}const WORKER_URLS=[`${API_BASE}/remix`,"https://www.bluedobiedev.com/api/remix"];async function maybeRemixWithAI(t,e){const{traits:o,custom:a,remember:n}=getBrandVoiceSelections(),r={email:e.email,drafts:t.map(((t,e)=>({id:String(e+1),text:t}))),platform:e.platform,tone:e.tone,length:e.length,ctaOptions:[e.cta].filter(Boolean),hashtags:buildHashtags(e.keywords,(e.hashtagDensity||"standard").toLowerCase(),!1!==e.cleanHashtags,e.platform,e.format),brandVoice:{traits:o,custom:a,remember:n}};for(const t of WORKER_URLS)try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok)continue;const o=await e.json();if(Array.isArray(o)&&o.length)return o.map((t=>String(t.text||""))).filter(Boolean)}catch{}return console.warn("AI remix unavailable; using local drafts"),t}function readBrief(){const t=t=>qs(`#${t}`)?.value?.trim()||"";return{email:t("email"),company:t("company"),offer:t("offer"),audience:t("audience"),problem:t("problem"),outcome:t("outcome"),cta:t("cta"),keywords:t("keywords"),platform:t("platform")||"Instagram",format:t("format")||"Post",length:t("captionLength")||"Medium",tone:parseFloat(t("tone")||"0.5"),hashtagDensity:t("hashtagDensity")||"Standard",cleanHashtags:!1!==qs("#cleanHashtags")?.checked}}!function(){const t=qs("#captionForm"),e=qs("#results");if(!t||!e)return void console.warn("DobieCore Captions: required DOM not found.");refreshFormats(),updateUsageCounter();const o=qs("#tone"),a=o?.nextElementSibling;o?.addEventListener("input",(()=>{const t=parseFloat(o.value||"0.5");a&&(a.textContent=t<.35?"Professional":t>.65?"Playful":"Balanced")})),qs("#platform")?.addEventListener("change",refreshFormats),qs("#format")?.addEventListener("change",updateFormatHint);const n=qs("#upgradeModal");qs("#upgradeBtn")?.addEventListener("click",(()=>window.location.href="https://buy.stripe.com/6oU8wPfjX591as29Hg3Je03")),qs("#alreadyProBtn")?.addEventListener("click",(()=>{const t=prompt("Enter the email you used to purchase (this will verify with our system):");t&&/\S+@\S+\.\S+/.test(t)?(localStorage.setItem("dcc_email",t.toLowerCase()),localStorage.removeItem("dcc_pro_cache"),localStorage.removeItem("dcc_pro_cache_time"),updateUsageCounter(),n?.setAttribute("hidden",""),alert("Checking your pro status. If you just purchased, please wait a moment and try generating a caption.")):alert("That email doesn't look valid.")})),qs("#closeModalBtn")?.addEventListener("click",(()=>n?.setAttribute("hidden",""))),window.addEventListener("click",(t=>{t.target===n&&n?.setAttribute("hidden","")})),t.addEventListener("submit",(async t=>{t.preventDefault();const o=readBrief();if(!o.email||!/\S+@\S+\.\S+/.test(o.email))return alert("Please enter a valid email address."),void qs("#email")?.focus();if(!o.offer)return alert("Please add what you're promoting (the Offer)."),void qs("#offer")?.focus();const a=await isPro();if(!a&&getUsage()>=3)return void n?.removeAttribute("hidden");const r=[makeCaption(o),makeCaption(o),makeCaption(o)];o.keywords&&""!==o.keywords.trim()||(o.keywords=extractKeywordsFromOffer(o.offer,o.platform));renderCards(await maybeRemixWithAI(r,o)),a||(incUsage(),updateUsageCounter()),e.scrollIntoView({behavior:"smooth",block:"start"})})),qs("#clearBtn")?.addEventListener("click",(()=>{["email","company","offer","audience","problem","outcome","cta","keywords"].forEach((t=>{const e=qs(`#${t}`);e&&(e.value="")})),qs("#captionLength")&&(qs("#captionLength").value="Medium"),qs("#hashtagDensity")&&(qs("#hashtagDensity").value="Standard"),qs("#cleanHashtags")&&(qs("#cleanHashtags").checked=!0),qs("#tone")&&(qs("#tone").value=.5),e.innerHTML=""}))}();